<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>HanimeAnnouncementManager</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h1 { text-align: center; }
    .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
    button { padding: 6px 12px; margin: 2px; border: none; border-radius: 4px; cursor: pointer; }
    button.edit { background: #1976d2; color: #fff; }
    button.delete { background: #d32f2f; color: #fff; }
    button.toggle { background: #388e3c; color: #fff; }
    #addForm { display: flex; flex-direction: column; gap: 6px; margin-top: 10px; }
    #addForm input, #addForm textarea { padding: 6px; width: 100%; }
  </style>

  <!-- 引入非模块化 Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>
  <h1>Hanime Announcement Manager</h1>
  <div class="container">
    <h2>新增公告</h2>
    <form id="addForm">
      <input type="text" id="title" placeholder="标题" required>
      <textarea id="content" placeholder="内容" required></textarea>
      <input type="text" id="imageUrl" placeholder="图片URL (可选)">
      <input type="number" id="priority" placeholder="优先级 (1-3)" value="2">
      <button type="submit">添加公告</button>
    </form>

    <h2>公告列表</h2>
    <table>
      <thead>
        <tr>
          <th>标题</th>
          <th>时间</th>
          <th>状态</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="announcementList"></tbody>
    </table>
  </div>

  <script>
    // Firebase 配置，由Firebase Web API生成
  const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    databaseURL: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: "",
    measurementId: ""
  };
  

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
	const auth = firebase.auth();

    const listEl = document.getElementById('announcementList');
    const addForm = document.getElementById('addForm');
	//配置管理员密码，在firebase控制台添加，需配置firebase realtime database访问规则，
	//并执行PermitAdmin.py授予写入权限
	  const ADMIN_EMAIL = "";
	  const ADMIN_PASSWORD = "";
	   auth.signInWithEmailAndPassword(ADMIN_EMAIL, ADMIN_PASSWORD)
    .then(() => {
      console.log("管理员登录成功");
      // 登录成功后加载公告
      loadAnnouncements();
    })
    .catch((error) => {
      console.error("管理员登录失败：", error.message);
      alert("管理员登录失败，请检查账号密码");
    });
  // 加载公告
  function loadAnnouncements() {
    db.ref('announcements').once('value').then(snapshot => {
      listEl.innerHTML = '';
      snapshot.forEach(child => {
        const data = child.val();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${data.title}</td>
          <td>${new Date(data.timestamp * 1000).toLocaleString()}</td>
          <td>${data.isActive ? '启用' : '停用'}</td>
          <td>
            <button class="toggle">${data.isActive ? '停用' : '启用'}</button>
            <button class="edit">编辑</button>
            <button class="delete">删除</button>
          </td>
        `;
        tr.querySelector('.toggle').onclick = () => toggleActive(child.key, !data.isActive);
        tr.querySelector('.delete').onclick = () => deleteAnnouncement(child.key);
        tr.querySelector('.edit').onclick = () => editAnnouncement(child.key, data);
        listEl.appendChild(tr);
      });
    });
  }

  // 新增公告
  addForm.onsubmit = e => {
    e.preventDefault();
    const newKey = db.ref('announcements').push().key;
    db.ref('announcements/' + newKey).set({
      title: document.getElementById('title').value,
      content: document.getElementById('content').value,
      imageUrl: document.getElementById('imageUrl').value || '',
      priority: parseInt(document.getElementById('priority').value || 2),
      timestamp: Math.floor(Date.now() / 1000),
      isActive: true
    }).then(() => {
      addForm.reset();
      loadAnnouncements();
    }).catch((err) => {
      alert("写入失败：" + err.message);
    });
  };

  function toggleActive(key, active) {
    db.ref('announcements/' + key + '/isActive').set(active).then(loadAnnouncements);
  }

  function deleteAnnouncement(key) {
    if (confirm('确定要删除该公告吗？')) {
      db.ref('announcements/' + key).remove().then(loadAnnouncements);
    }
  }

  function editAnnouncement(key, data) {
    const newTitle = prompt('修改标题：', data.title);
    if (newTitle !== null) {
      const newContent = prompt('修改内容：', data.content);
      if (newContent !== null) {
        db.ref('announcements/' + key).update({
          title: newTitle,
          content: newContent
        }).then(loadAnnouncements);
      }
    }
  }
</script>
</body>
</html>
